<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LiveSky Odyssey</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    html, body {
      min-height: 100vh;
      width: 100%;
    }

    body {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
      color: white;
      padding: 40px 0;
      transition: background-image 1s ease-in-out;
    }

    .weather-container {
      width: 90%;
      max-width: 600px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      margin: 0 auto;
    }

    h2 {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    #location {
      font-size: 1.5rem;
      margin-bottom: 10px;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    h1 {
      font-size: 4rem;
      margin: 10px 0;
    }

    .weather-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .detail-box {
      background: rgba(255, 255, 255, 0.2);
      padding: 10px;
      border-radius: 10px;
      font-size: 1.1rem;
      flex: 1 1 45%;
      min-width: 120px;
    }

    .forecast-container {
      margin-top: 20px;
    }

    canvas {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      margin-top: 10px;
    }

    @media screen and (max-height: 700px) {
      .weather-container {
        max-height: 90vh;
        overflow-y: auto;
      }
    }
  </style>
</head>
<body>
  <div class="weather-container">
    <h2>LiveSky Odyssey</h2>
    <h3 id="location">Fetching location...</h3>
    <h1 id="temperature">--°C</h1>
    <p id="condition">--</p>

    <div class="weather-details">
      <div class="detail-box"><h3>Feels Like</h3><p id="feels-like">--°C</p></div>
      <div class="detail-box"><h3>Humidity</h3><p id="humidity">--%</p></div>
      <div class="detail-box"><h3>Wind</h3><p id="wind">-- km/h</p></div>
      <div class="detail-box"><h3>Precipitation</h3><p id="precip">-- mm</p></div>
      <div class="detail-box"><h3>Visibility</h3><p id="visibility">-- km</p></div>
      <div class="detail-box"><h3>UV Index</h3><p id="uv">--</p></div>
    </div>

    <div class="forecast-container">
      <h3>Hourly Forecast (Today)</h3>
      <div class="weather-details" id="hourly-forecast"></div>
      <h3>5-Day Forecast</h3>
      <canvas id="forecastChart"></canvas>
    </div>
  </div>

  <script>
    const apiKey = "30e42fd27464024a1c78c545b41c1ace";

    function updateBackground(condition, isNight) {
      let imageUrl = "";

      condition = condition.toLowerCase();

      if (condition.includes("rain")) {
        imageUrl = "images/rain.gif";
      } else if (condition.includes("snow")) {
        imageUrl = isNight ? "images/night_snow.gif" : "images/snow.gif";
      } else if (condition.includes("clear")) {
        imageUrl = isNight ? "images/night_clear.gif" : "images/sunny.gif";
      } else {
        imageUrl = isNight ? "images/night_clear.gif" : "images/sunny.gif"; // fallback
      }

      document.body.style.backgroundImage = `url('${imageUrl}')`;
    }

    function isCurrentlyNight(sunrise, sunset) {
      const now = Math.floor(Date.now() / 1000);
      return now < sunrise || now > sunset;
    }

    function fetchWeather(lat, lon) {
      const currentURL = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`;
      const forecastURL = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&appid=${apiKey}`;

      fetch(currentURL)
        .then(res => res.json())
        .then(data => {
          const { temp, feels_like, humidity } = data.main;
          const wind = data.wind.speed;
          const visibility = (data.visibility / 1000).toFixed(1);
          const condition = data.weather[0].main;
          const description = data.weather[0].description;
          const precip = data.rain ? `${data.rain["1h"] || 0} mm` : "0 mm";
          const uvIndex = data.uvi || "--";
          const isNight = isCurrentlyNight(data.sys.sunrise, data.sys.sunset);

          document.getElementById("location").innerText = data.name;
          document.getElementById("temperature").innerText = `${Math.round(temp)}°C`;
          document.getElementById("feels-like").innerText = `${Math.round(feels_like)}°C`;
          document.getElementById("humidity").innerText = `${humidity}%`;
          document.getElementById("wind").innerText = `${wind} km/h`;
          document.getElementById("visibility").innerText = `${visibility} km`;
          document.getElementById("precip").innerText = precip;
          document.getElementById("uv").innerText = uvIndex;
          document.getElementById("condition").innerText = description;

          updateBackground(condition, isNight);
        });

      fetch(forecastURL)
        .then(res => res.json())
        .then(data => {
          const hourlyContainer = document.getElementById("hourly-forecast");
          hourlyContainer.innerHTML = "";

          const temps = {};
          const labels = [];

          data.list.forEach(item => {
            const date = new Date(item.dt_txt);
            const hour = date.getHours();
            const today = new Date().getDate();
            const itemDay = date.getDate();
            const dayLabel = date.toLocaleDateString(undefined, { weekday: 'short' });

            if (today === itemDay && hourlyContainer.childNodes.length < 6) {
              const card = document.createElement("div");
              card.className = "detail-box";
              card.innerHTML = `<strong>${hour}:00</strong><br>${Math.round(item.main.temp)}°C<br>${item.weather[0].main}`;
              hourlyContainer.appendChild(card);
            }

            if (!temps[dayLabel]) temps[dayLabel] = [];
            temps[dayLabel].push(item.main.temp);
          });

          for (let day in temps) {
            const avg = temps[day].reduce((a, b) => a + b, 0) / temps[day].length;
            labels.push(day);
            temps[day] = parseFloat(avg.toFixed(1));
          }

          drawForecastGraph(labels.slice(0, 5), Object.values(temps).slice(0, 5));
        });
    }

    function drawForecastGraph(labels, data) {
      const ctx = document.getElementById("forecastChart").getContext("2d");
      if (window.myChart) window.myChart.destroy();

      window.myChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: "Avg Temp (°C)",
            data: data,
            borderColor: "white",
            backgroundColor: "rgba(255, 255, 255, 0.2)",
            borderWidth: 2,
            fill: true,
            tension: 0.4,
          }]
        },
        options: {
          scales: {
            x: { ticks: { color: "white" } },
            y: { ticks: { color: "white" } }
          },
          plugins: {
            legend: { labels: { color: "white" } }
          }
        }
      });
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          fetchWeather(pos.coords.latitude, pos.coords.longitude);
        }, () => {
          alert("Unable to get location. Please enable location access.");
        });
      } else {
        alert("Geolocation is not supported by this browser.");
      }
    }

    getLocation();
  </script>
</body>
</html>